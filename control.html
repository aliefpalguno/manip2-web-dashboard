<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Robot Control Center</title>
  <!-- Minimal, native stack. No frameworks. Sharing styles with index.html -->
  <style>
    :root{
      /* Core Palette */
      --bg: #f3f4f6;
      --panel: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --ok: #22c55e;
      --warn: #f59e0b;
      --crit: #ef4444;
      --crit-bg: #fef2f2;
      --border: #e2e8f0;
      
      /* UI Vars */
      --grid-gap: 24px;
      --radius: 16px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--ink); 
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
    }

    /* --- Layout --- */
    header{
      display:flex; align-items:center; gap:18px; padding:0 24px; 
      height: 64px;
      background: #ffffff; 
      border-bottom: 1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    header h1{font-size:20px; font-weight:700; letter-spacing:-0.5px; margin:0; color: var(--ink);}
    header .brand{margin-left:auto; font-size: 14px; font-weight:500; color: var(--muted);}

    .shell{display:grid; grid-template-columns: 72px 1fr; min-height:calc(100vh - 64px)}
    
    /* --- Nav --- */
    nav{
      background: #ffffff; 
      border-right: 1px solid var(--border);
      padding: 20px 0; 
      display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    nav .dot{
      width:44px; height:44px; border-radius:12px; 
      background: transparent; 
      display:grid; place-items:center; 
      color: var(--muted); font-size:20px; 
      cursor: pointer; transition: all .2s ease;
      text-decoration: none;
    }
    nav .dot:hover{ background: #f1f5f9; color: var(--primary); transform: scale(1.05); }
    nav .dot.active{ background: #eff6ff; color: var(--primary); }

    /* --- Main Grid Modified for 3 Columns --- */
    .main{padding: 24px; max-width: 1800px; margin: 0 auto; width: 100%;}
    .grid-3{
      display:grid; 
      /* Create 3 equal columns */
      grid-template-columns: repeat(3, 1fr); 
      gap:var(--grid-gap);
      align-items: start; /* Align cards to top */
    }
    
    /* --- Cards --- */
    .card{
      background: var(--panel); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow); 
      border: 1px solid var(--border);
      overflow:hidden;
      display: flex; flex-direction: column;
      height: 100%; /* Fill column height */
    }
    .card header{
      position:unset; height: auto; border: none;
      background: transparent; padding: 16px 20px; 
      border-bottom: 1px solid #f1f5f9;
    }
    .card .title{font-weight:600; font-size:15px; color: var(--ink);}
    .card .body{padding:20px; height: 100%;}
    .card .body.padless{padding:0}

    /* --- Viz --- */
    #viz3d{width:100%; height:500px; background:#111827; display:block;}

    /* --- Quick Actions Styles (Reused) --- */
    .qa-container { display: flex; flex-direction: column; gap: 24px; }
    .motion-control { display: flex; flex-direction: column; gap: 16px; }
    .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; }
    .tab-btn {
      flex: 1; border: none; background: transparent;
      padding: 8px; border-radius: 8px;
      font-size: 13px; font-weight: 600; color: var(--muted);
      cursor: pointer; transition: all 0.2s;
    }
    .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .panel-content { display: none; animation: fadeIn 0.2s ease; }
    .panel-content.active { display: block; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }
    .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
    .input-grid.joints { grid-template-columns: repeat(5, 1fr); } 
    .field-group { position: relative; }
    .field-group label { display: block; font-size: 11px; font-weight: 600; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; }
    .field-group input {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 14px; font-weight: 500; color: var(--ink); outline: none; transition: all 0.2s; background: #fff;
    }
    .field-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
    .field-group .unit { position: absolute; right: 12px; top: 29px; font-size: 11px; color: #94a3b8; pointer-events: none; }
    .btn-action {
      width: 100%; border: none; padding: 12px; border-radius: 10px; cursor: pointer;
      font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn-action:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 6px -2px rgba(59,130,246,0.3); }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-confirm { background: var(--ok); color: #fff; box-shadow: 0 4px 6px -2px rgba(34, 197, 94, 0.3); }
    .btn-confirm:hover { background: #16a34a; }
    
    .system-ops { display: flex; flex-direction: column; gap: 20px; border-top: 1px solid var(--border); padding-top: 24px; }
    .sys-section h4 { margin: 0 0 10px 0; font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: 700; letter-spacing: 0.05em; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn-sec {
      background: #fff; border: 1px solid var(--border); color: var(--ink);
      padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-sec:hover { border-color: #cbd5e1; background: #f8fafc; }
    .btn-danger { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
    .btn-danger:hover { background: #fee2e2; border-color: #fca5a5; }
    .danger-zone { background: #fff1f2; border: 1px dashed #fecaca; padding: 12px; border-radius: 10px; }
    .status-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: auto; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600;
      padding: 4px 10px; border-radius: 99px; background: #f1f5f9; color: var(--muted); border: 1px solid transparent;
    }
    .pill.active { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .dot-ind { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* --- NEW SLIDER PANEL STYLES --- */
    .slider-container {
      display: flex; flex-direction: column; gap: 24px;
      background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border);
    }
    .slider-group { display: flex; flex-direction: column; gap: 8px; position: relative;}
    .slider-header { display: flex; justify-content: space-between; align-items: center; }
    .slider-header label { font-size: 13px; font-weight: 700; color: var(--ink); }
    .slider-val-input {
      width: 80px; padding: 6px 10px; border: 1px solid var(--border);
      border-radius: 6px; font-size: 13px; font-weight: 600; text-align: right;
      color: var(--primary); background: #fff; transition: all 0.2s;
    }
    /* Visual cue when value is modified manually */
    .slider-val-input.modified {
        border-color: var(--primary); background-color: #eff6ff; color: var(--primary-dark);
    }
    
    /* Custom Range Input Styling */
    input[type=range] {
      -webkit-appearance: none; width: 100%; height: 6px;
      background: #e2e8f0; border-radius: 5px; outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
      background: #fff; border: 2px solid var(--muted); border-radius: 50%;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s, border-color 0.2s;
    }
    input[type=range].modified::-webkit-slider-thumb {
        border-color: var(--primary); background: var(--primary);
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
    
    .live-indicator {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px;
    }
    .live-badge {
        display: inline-flex; align-items: center; gap:6px; 
        font-size: 12px; color: var(--muted); font-weight: 600;
        background: #f1f5f9; padding: 4px 10px; border-radius: 20px;
    }
    .live-badge.syncing { color: var(--ok); background: #dcfce7; }
    .live-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; }
    .live-badge.syncing .live-dot { animation: pulse 1.5s infinite; }
    
    @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }

    /* Responsive */
    @media (max-width: 1400px) {
      .grid-3 { grid-template-columns: 1fr 1fr; }
      /* Move sliders to bottom on medium screens */
      .col-sliders { grid-column: span 2; } 
    }
    @media (max-width: 900px) {
      .grid-3 { display: flex; flex-direction: column; }
      .col-sliders { grid-column: auto; }
      .shell { grid-template-columns: 1fr; }
      nav { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Control Center</h1>
    <div class="brand">Robot Monitoring System</div>
  </header>
  
  <div class="shell">
    <nav>
      <a href="index.html" class="dot" title="Home">üè†</a>
      <a href="control.html" class="dot active" title="Control">ü§ñ</a> 
      <a href="analytics.html" class="dot" title="Analytics">üìà</a>
      <div class="dot" title="Settings">‚öôÔ∏è</div>
    </nav>

    <main class="main">
      <!-- 3-COLUMN GRID LAYOUT -->
      <div class="grid-3">
        
        <!-- COLUMN 1: 3D VISUALIZATION -->
        <div class="col-viz">
          <section class="card" style="height: 600px;"> <!-- Fixed height for alignment -->
            <header><div class="title">3D Real-time View</div></header>
            <div class="body padless" style="height: 100%;"><div id="viz3d" style="height: 100%;"></div></div>
          </section>
        </div>

        <!-- COLUMN 2: QUICK ACTIONS (Reused from index.html) -->
        <div class="col-actions">
          <section class="card">
            <header><div class="title">Quick Actions & System</div></header>
            <div class="body">
              <div class="qa-container">
                
                <!-- Motion Control Panel -->
                <div class="motion-control">
                  <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('xyz')">üìç Coordinates</button>
                    <button class="tab-btn" onclick="switchTab('joints')">ü§ñ Joint Setpoint</button>
                  </div>

                  <div id="panel-xyz" class="panel-content active">
                    <div class="input-grid">
                      <div class="field-group"><label>X Axis</label><input type="number" step="0.1" id="in-x" placeholder="0.0"><span class="unit">cm</span></div>
                      <div class="field-group"><label>Y Axis</label><input type="number" step="0.1" id="in-y" placeholder="0.0"><span class="unit">cm</span></div>
                      <div class="field-group"><label>Z Axis</label><input type="number" step="0.1" id="in-z" placeholder="0.0"><span class="unit">cm</span></div>
                    </div>
                    <button class="btn-action btn-primary" id="btn-send-xyz">Move to Coordinates ‚ûú</button>
                  </div>

                  <div id="panel-joints" class="panel-content">
                    <div class="input-grid joints">
                      <div class="field-group"><label>J1</label><input type="number" id="j1" placeholder="0"><span class="unit">¬∞</span></div>
                      <div class="field-group"><label>J2</label><input type="number" id="j2" placeholder="0"><span class="unit">¬∞</span></div>
                      <div class="field-group"><label>J3</label><input type="number" id="j3" placeholder="0"><span class="unit">¬∞</span></div>
                      <div class="field-group"><label>J4</label><input type="number" id="j4" placeholder="0"><span class="unit">¬∞</span></div>
                      <div class="field-group"><label>J5</label><input type="number" id="j5" placeholder="0"><span class="unit">¬∞</span></div>
                    </div>
                    <button class="btn-action btn-primary" id="btn-send-joints">Set Joint Angles ‚ûú</button>
                    <p style="font-size: 11px; color: var(--muted); margin-top: 8px;">* Sets a static target point.</p>
                  </div>
                </div>

                <!-- System Operations -->
                <div class="system-ops">
                  <div class="sys-section">
                    <h4>Connection</h4>
                    <div class="btn-grid">
                      <button class="btn-sec" id="btn-connect">Connect</button>
                      <button class="btn-sec" id="btn-disconnect">Disconnect</button>
                    </div>
                  </div>

                  <div class="sys-section">
                    <h4>Operations</h4>
                    <div class="btn-grid">
                      <button class="btn-sec" id="btn-initial">üè† Home</button>
                      <button class="btn-sec" id="btn-safety-reset">üõ°Ô∏è Reset Safety</button>
                    </div>
                  </div>
                  
                  <div class="sys-section danger-zone">
                      <h4 style="color:#ef4444">Danger Zone</h4>
                      <div class="btn-grid">
                        <button class="btn-sec btn-danger" id="btn-safe-shutdown">Safe Halt</button>
                        <button class="btn-sec btn-danger" id="btn-force-shutdown">Force Off</button>
                      </div>
                  </div>

                  <div class="status-bar">
                    <div class="pill" id="pill-ws"><span class="dot-ind"></span> Gateway</div>
                    <div class="pill" id="pill-ros"><span class="dot-ind"></span> ROS Bridge</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- COLUMN 3: NEW SLIDERS -->
        <div class="col-sliders">
            <section class="card">
                <header><div class="title">Jog Control (Manual)</div></header>
                <div class="body">
                    <div class="live-indicator">
                        <div class="live-badge syncing" id="sync-badge"><div class="live-dot"></div> Live Sync</div>
                        <button class="btn-sec" style="padding: 4px 8px; font-size: 11px;" id="btn-resync">Reset to Live</button>
                    </div>
                    
                    <div class="slider-container">
                        <!-- Joint 1 Slider -->
                        <div class="slider-group">
                            <div class="slider-header">
                                <label for="range-j1">Joint 1 (Base)</label>
                                <input type="number" id="val-j1" class="slider-val-input" value="0" min="-90" max="90" step="0.1">
                            </div>
                            <input type="range" id="range-j1" min="-90" max="90" value="0" step="0.1">
                        </div>

                        <!-- Joint 2 Slider -->
                        <div class="slider-group">
                            <div class="slider-header">
                                <label for="range-j2">Joint 2 (Shoulder)</label>
                                <input type="number" id="val-j2" class="slider-val-input" value="0" min="-30" max="45" step="0.1">
                            </div>
                            <input type="range" id="range-j2" min="-30" max="45" value="0" step="0.1">
                        </div>

                        <!-- Joint 3 Slider -->
                        <div class="slider-group">
                            <div class="slider-header">
                                <label for="range-j3">Joint 3 (Elbow)</label>
                                <input type="number" id="val-j3" class="slider-val-input" value="-45" min="-105" max="0" step="0.1">
                            </div>
                            <input type="range" id="range-j3" min="-105" max="0" value="-45" step="0.1">
                        </div>

                        <!-- Joint 4 Slider -->
                        <div class="slider-group">
                            <div class="slider-header">
                                <label for="range-j4">Joint 4 (Wrist Pitch)</label>
                                <input type="number" id="val-j4" class="slider-val-input" value="0" min="-77" max="113" step="0.1">
                            </div>
                            <input type="range" id="range-j4" min="-77" max="113" value="0" step="0.1">
                        </div>

                        <!-- Joint 5 Slider -->
                        <div class="slider-group">
                            <div class="slider-header">
                                <label for="range-j5">Joint 5 (Wrist Roll)</label>
                                <input type="number" id="val-j5" class="slider-val-input" value="0" min="-103" max="103" step="0.1">
                            </div>
                            <input type="range" id="range-j5" min="-103" max="103" value="0" step="0.1">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-action btn-confirm" id="btn-submit-sliders">Submit Move ‚ûú</button>
                        <p style="font-size: 11px; color: var(--muted); margin-top: 8px; text-align: center;">
                            Sliders track robot position until moved. Click "Reset" to re-sync.
                        </p>
                    </div>
                </div>
            </section>
        </div>

      </div>
    </main>
  </div>

  <!-- Vendor Libs (Same as index.html) -->
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.5/lib/eventemitter2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ros3d@1/build/ros3d.min.js"></script>

  <script>
    // ==========================================
    //  PERSISTENT LOGGING (SESSION STORAGE)
    // ==========================================
    function log(line, cls) {
        // 1. Save to SessionStorage
        const entry = { timestamp: Date.now(), line: line, cls: cls };
        let history = [];
        try {
            history = JSON.parse(sessionStorage.getItem('robot_logs') || '[]');
        } catch(e) {}
        
        history.push(entry);
        if (history.length > 200) history.shift(); // Keep last 200
        sessionStorage.setItem('robot_logs', JSON.stringify(history));

        // Note: We don't have a log view in this page, but we save it so 
        // analytics.html or index.html can see it.
        console.log(`[LOG] ${line}`);
    }

    // ==========================================
    //  CORE SETUP
    // ==========================================
    function switchTab(mode) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if(mode === 'xyz') document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
      else document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
      document.querySelectorAll('.panel-content').forEach(p => p.classList.remove('active'));
      document.getElementById(mode === 'xyz' ? 'panel-xyz' : 'panel-joints').classList.add('active');
    }

    let CONFIG = {
      ROSBRIDGE_URL: 'ws://localhost:9090',
      NODE_RED_WS_URL: (location.search.match(/nodered=([^&]+)/)?.[1]) || 'ws://8.215.67.35:1880/ws/robot',
      ROBOT_DESCRIPTION_PARAM: '/robot_description',
      FIXED_FRAME: 'base_link',
      URDF_PATH: (location.search.match(/urdfpath=([^&]+)/)?.[1]) || '/',
      AUTO_CONNECT: true
    };

    const $ = sel => document.querySelector(sel);

    function setDot(type, on){
      const el = $(`#pill-${type}`);
      if(!el) return;
      if(on) el.classList.add('active');
      else el.classList.remove('active');
    }

    const newCid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2,8));

    // ==========================================
    //  WEBSOCKET CONNECTION (Node-RED Gateway)
    // ==========================================
    let ws = null, wsTimer = null;
    
    // Joint Sync State
    const dirtyFlags = [false, false, false, false, false]; 
    const joints = [1, 2, 3, 4, 5];

    function wsConnect(){
      if(ws && (ws.readyState<=1)) return;
      try{ ws = new WebSocket(CONFIG.NODE_RED_WS_URL); }catch(e){ console.error('WS Init Error', e); return; }
      ws.onopen = () => { setDot('ws', true); log('<b>WS:</b> Connected', 'info'); ping(); };
      ws.onclose = () => { setDot('ws', false); log('<b>WS:</b> Disconnected', 'warn'); if(wsTimer) clearTimeout(wsTimer); wsTimer = setTimeout(wsConnect, 1500); };
      
      ws.onmessage = (ev) => {
        let msg = null;
        try{ msg = JSON.parse(ev.data); }catch{ }
        if(!msg) return;

        // --- TELEMETRY HANDLING ---
        if((msg.type === 'telemetry' || msg.schema === 'manip2.v1') && msg.data && msg.data.joints) {
            updateSlidersFromTelemetry(msg.data.joints);
        }
        
        // Log Critical Events
        if(msg.type === 'safety_event') log(`<b>SAFETY:</b> ${msg.text}`, 'crit');
        if(msg.type === 'cmd_result') {
            const isErr = msg.status !== 'ok';
            log(`<b>CMD:</b> ${msg.status.toUpperCase()} - ${msg.message||''}`, isErr ? 'warn' : 'info');
        }
      };
    }
    function ping(){ if(ws && ws.readyState===1){ ws.send(JSON.stringify({type:'ping', t:Date.now()})); setTimeout(ping, 10000); } }
    
    function wsSend(obj){ 
        if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); 
        else console.warn('WS not connected, cannot send command'); 
    }

    function updateSlidersFromTelemetry(jointData) {
        // Check if we are totally dirty (all sliders modified), if so, update badge
        const anyDirty = dirtyFlags.some(f => f);
        const badge = document.getElementById('sync-badge');
        if(anyDirty) {
            badge.classList.remove('syncing');
            badge.innerHTML = 'Manual Mode';
        } else {
            badge.classList.add('syncing');
            badge.innerHTML = '<div class="live-dot"></div> Live Sync';
        }

        const currentPos = [0,0,0,0,0];
        jointData.forEach((j, i) => {
            if(i < 5) currentPos[i] = j.pos_deg;
        });

        joints.forEach((id, idx) => {
            if(!dirtyFlags[idx]) {
                const range = document.getElementById(`range-j${id}`);
                const val = document.getElementById(`val-j${id}`);
                const v = currentPos[idx];
                
                if (Math.abs(parseFloat(range.value) - v) > 0.05) {
                    range.value = v;
                    val.value = v.toFixed(1);
                }
            }
        });
    }

    // ==========================================
    //  ROS / 3D VIZ CONNECTION
    // ==========================================
    let ros = null, viewer = null, tfClient = null, urdfClient = null;
    function rosConnect(){
      if(ros && ros.isConnected) return;
      ros = new ROSLIB.Ros({ url: CONFIG.ROSBRIDGE_URL });
      ros.on('connection', ()=>{ setDot('ros', true); log('<b>ROS:</b> Connected', 'info'); initViewer(); });
      ros.on('error', ()=>{ setDot('ros', false); log('<b>ROS:</b> Error', 'crit'); });
      ros.on('close', ()=>{ setDot('ros', false); setTimeout(rosConnect, 2000); });
    }

    function initViewer(){
      const el = document.getElementById('viz3d');
      if(viewer) { el.innerHTML = ''; viewer = null; } 
      
      viewer = new ROS3D.Viewer({ divID: 'viz3d', width: el.clientWidth, height: el.clientHeight, antialias: true, background: '#111827', intensity: 1.5 });
      window.addEventListener('resize', ()=>{ if(viewer && el.clientWidth > 0) viewer.resize(el.clientWidth, el.clientHeight); });
      viewer.addObject(new ROS3D.Grid({ color: '#374151', num_cells: 20, cell_size: 10 }));
      
      if(!tfClient) tfClient = new ROSLIB.TFClient({ ros, fixedFrame: CONFIG.FIXED_FRAME, angularThres: 0.01, transThres: 0.01, rate: 20 });
      if(!urdfClient) urdfClient = new ROS3D.UrdfClient({ ros, tfClient, rootObject: viewer.scene, param: CONFIG.ROBOT_DESCRIPTION_PARAM, path: CONFIG.URDF_PATH });
    }

    // ==========================================
    //  QUICK ACTIONS HANDLERS
    // ==========================================
    document.getElementById('btn-connect').onclick    = ()=>{ wsConnect(); rosConnect(); };
    document.getElementById('btn-disconnect').onclick = ()=>{ try{ws.close();}catch{} try{ros.close();}catch{} };
    document.getElementById('btn-initial').onclick = ()=> wsSend({ type:'command', command_id:newCid(), cmd:'go_initial' });
    document.getElementById('btn-safety-reset').onclick = ()=> wsSend({ type:'command', command_id:newCid(), cmd:'safety_reset' });

    // Danger Zone
    document.getElementById('btn-safe-shutdown').onclick = ()=> wsSend({ type:'command', command_id:newCid(), cmd:'safe_shutdown' });
    document.getElementById('btn-force-shutdown').onclick = ()=> wsSend({ type:'command', command_id:newCid(), cmd:'force_shutdown' });


    document.getElementById('btn-send-joints').onclick = ()=>{
      const vals = ['j1','j2','j3','j4','j5'].map(id=>parseFloat(document.getElementById(id).value));
      if (vals.some(v => Number.isNaN(v))) { alert('Invalid joint inputs'); return; }
      wsSend({ type:'command', command_id:newCid(), cmd:'set_joint_deg', joints: vals });
    };

    document.getElementById('btn-send-xyz').onclick = ()=>{
      const x = parseFloat(document.getElementById('in-x').value);
      const y = parseFloat(document.getElementById('in-y').value);
      const z = parseFloat(document.getElementById('in-z').value);
      if([x,y,z].some(v=>Number.isNaN(v))){ alert('Invalid coordinates'); return; }
      wsSend({ type:'command', command_id:newCid(), cmd:'set_target_xyz', target:{x,y,z}, units:'cm' });
    };


    // ==========================================
    //  SLIDER LOGIC (Manual + Sync)
    // ==========================================
    
    function markDirty(idx) {
        dirtyFlags[idx] = true;
        document.getElementById(`range-j${joints[idx]}`).classList.add('modified');
        document.getElementById(`val-j${joints[idx]}`).classList.add('modified');
        
        const badge = document.getElementById('sync-badge');
        badge.classList.remove('syncing');
        badge.innerHTML = 'Manual Mode';
    }

    function resetSync() {
        dirtyFlags.fill(false);
        joints.forEach(id => {
            document.getElementById(`range-j${id}`).classList.remove('modified');
            document.getElementById(`val-j${id}`).classList.remove('modified');
        });
    }

    document.getElementById('btn-resync').onclick = resetSync;

    joints.forEach((id, idx) => {
        const range = document.getElementById(`range-j${id}`);
        const val = document.getElementById(`val-j${id}`);

        range.addEventListener('input', (e) => {
            val.value = e.target.value;
            markDirty(idx);
        });

        val.addEventListener('input', (e) => {
            let v = parseFloat(e.target.value);
            if(!isNaN(v)) {
                if(v < parseFloat(range.min)) v = parseFloat(range.min);
                if(v > parseFloat(range.max)) v = parseFloat(range.max);
                range.value = v;
                markDirty(idx);
            }
        });
    });

    // SUBMIT BUTTON
    document.getElementById('btn-submit-sliders').onclick = () => {
        const currentJointsDeg = joints.map(id => {
            return parseFloat(document.getElementById(`val-j${id}`).value) || 0;
        });
        
        wsSend({ 
            type:'command', 
            command_id: 'jog_' + newCid(), 
            cmd:'set_joint_deg', 
            joints: currentJointsDeg 
        });
        log('<b>Control:</b> Manual Jog Command Sent', 'info');
    };

    // ==========================================
    //  INIT
    // ==========================================
    fetch('config.json')
      .then(r => r.json())
      .then(data => { if(data.rosbridge_ip) CONFIG.ROSBRIDGE_URL = data.rosbridge_ip; })
      .catch(() => { console.log('Using default IP'); })
      .finally(() => {
          if(CONFIG.AUTO_CONNECT){ wsConnect(); rosConnect(); }
          log('System ready');
      });
  </script>
</body>
</html>